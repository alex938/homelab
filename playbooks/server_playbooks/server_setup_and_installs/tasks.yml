---
- name: Maintenance and Health Checks
  hosts: homelab:k8s
  become: true
  vars_files:
    - vault2.yml

  tasks:
    # ---------------------------------------------------------
    # Docker Maintenance
    # ---------------------------------------------------------
    - name: Prune Docker system (containers, images, networks)
      ansible.builtin.command:
        cmd: "docker system prune -a -f --volumes"
      register: docker_prune_output
      changed_when: "'Total reclaimed space: 0B' not in docker_prune_output.stdout"

    # ---------------------------------------------------------
    # APT (Debian/Ubuntu) Maintenance
    # ---------------------------------------------------------
    - name: Fix broken apt sources
      ansible.builtin.command:
        cmd: "apt-get update --fix-missing"
      ignore_errors: yes
      when: ansible_distribution in ["Ubuntu", "Debian"]

    - name: Update and upgrade packages (Debian/Ubuntu)
      apt:
        upgrade: dist
        update_cache: yes
        force_apt_get: yes
        autoclean: yes
        autoremove: yes
      when: ansible_distribution in ["Ubuntu", "Debian"]
      register: apt_result

    - name: Check if reboot is required (Debian/Ubuntu)
      stat:
        path: /var/run/reboot-required
      register: reboot_required_file
      when: ansible_distribution in ["Ubuntu", "Debian"]

    # ---------------------------------------------------------
    # YUM/DNF (CentOS/RedHat) Maintenance
    # ---------------------------------------------------------
    - name: Update and upgrade packages (CentOS)
      yum:
        name: "*"
        state: latest
        update_cache: yes
        autoremove: yes
      when: ansible_distribution == "CentOS"
      register: yum_result

    - name: Check if reboot is required (CentOS)
      command: needs-restarting -r
      register: centos_reboot_check
      failed_when: false
      changed_when: false
      when: ansible_distribution == "CentOS"

    # ---------------------------------------------------------
    # System Cleanup & Health
    # ---------------------------------------------------------
    - name: Clean up journal logs (keep 2 weeks)
      ansible.builtin.command: journalctl --vacuum-time=2weeks
      when: ansible_os_family in ["Debian", "RedHat"]
      changed_when: false

    - name: Clean old files from /tmp (older than 7 days)
      find:
        paths: /tmp
        age: 7d
        recurse: yes
      register: tmp_files_to_delete

    - name: Remove old files from /tmp
      file:
        path: "{{ item.path }}"
        state: absent
      with_items: "{{ tmp_files_to_delete.files }}"
      loop_control:
        label: "{{ item.path }}"

    - name: Check for failed systemd services
      command: systemctl list-units --state=failed --no-legend
      register: failed_services
      changed_when: false

    # ---------------------------------------------------------
    # Reporting
    # ---------------------------------------------------------
    - name: Gather all facts
      ansible.builtin.setup:

    - name: Final System Report
      debug:
        msg: |
          ============================
          System Health Report
          ============================
          Hostname: {{ ansible_hostname }}
          Distro:   {{ ansible_distribution }} {{ ansible_distribution_version }}
          Uptime:   {{ ansible_uptime_seconds | int // 3600 }} hours, {{ (ansible_uptime_seconds | int % 3600) // 60 }} minutes

          Updates:
          - APT/YUM Changed: {{ apt_result.changed | default(yum_result.changed | default(false)) }}

          Reboot Status:
          - Debian/Ubuntu: {{ reboot_required_file.stat.exists | default(false) }}
          - CentOS: {{ centos_reboot_check.rc | default(0) == 1 }}

          Resources:
          - CPU Cores: {{ ansible_processor_vcpus }}
          - Memory: {{ ansible_memtotal_mb }} MB Total / {{ ansible_memfree_mb }} MB Free
          - Disk (/): {{ (ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='size_available') | first | default(0) // 1024**3) }} GB Free

          Issues Found:
          - Failed Services: {{ failed_services.stdout_lines | default('None') }}
          ============================
